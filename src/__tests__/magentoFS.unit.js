/**
 * Copyright Â© Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */

const { join, relative } = require('path');
const {
    findMagentoRoot,
    getEnabledModules,
    getStaticDirForTheme,
    getDeployedThemes,
} = require('../magentoFS');

const getFixturePath = fixtureName =>
    join(__dirname, '__fixtures__', fixtureName);

test('findMagentoRoot finds root at some level', async () => {
    const dir = getFixturePath('find-magento-root-same-level');
    const result = await findMagentoRoot(dir);

    const relResult = relative(__dirname, result);
    expect(relResult).toBe('__fixtures__/find-magento-root-same-level');
});

test('findMagentoRoot finds root in parent dir', async () => {
    const dir = join(getFixturePath('find-magento-root-one-up'), 'app');
    const result = await findMagentoRoot(dir);

    const relResult = relative(__dirname, result);
    expect(relResult).toBe('__fixtures__/find-magento-root-one-up');
});

test('findMagentoRoot returns undefined for invalid dir path', async () => {
    const result = await findMagentoRoot('/not/a/real/path');
    expect(result).toEqual(undefined);
});

test('getStaticDirForTheme', () => {
    const theme = {
        vendor: 'Magento',
        name: 'luma',
        themeID: 'Magento/luma',
        area: 'frontend',
        path: '/some/file/path',
    };
    expect(getStaticDirForTheme(theme)).toBe(
        'pub/static/frontend/Magento/luma',
    );
});

test('getDeployedThemese', async () => {
    const magentoRoot = getFixturePath('get-deployed-themes');
    const deployedThemes = await getDeployedThemes(magentoRoot);
    expect(deployedThemes).toEqual(['Magento/luma', 'Magento/backend']);
});

test('getEnabledModules throws descriptive warning when config.php cannot be found', async () => {
    expect(
        getEnabledModules('/some/magento/root/missing/config'),
    ).rejects.toThrow(/Failed to read list of enabled modules from .+/);
});

test('Can parse config dumped with app:config:dump', async () => {
    const magentoRoot = join(
        __dirname,
        '__fixtures__',
        'app-with-dumped-config-php',
    );
    const enabledModules = await getEnabledModules(magentoRoot);
    expect(enabledModules).toEqual([
        'Magento_Store',
        'Magento_AdvancedPricingImportExport',
        'Magento_Directory',
        'Magento_Amqp',
        'Magento_Config',
        'Magento_Theme',
        'Magento_Backend',
        'Magento_Variable',
        'Magento_Eav',
        'Magento_Search',
        'Magento_Backup',
        'Magento_Customer',
        'Magento_AdminNotification',
        'Magento_Authorization',
        'Magento_BundleImportExport',
        'Magento_Indexer',
        'Magento_Bundlegento',
        'Magento_CacheInvalidate',
        'Magento_Cms',
        'Magento_Catalog',
        'Magento_Security',
        'Magento_GraphQl',
        'Magento_CatalogImportExport',
        'Magento_Quote',
        'Magento_CatalogInventory',
        'Magento_Rule',
        'Magento_Msrp',
        'Magento_CatalogRule',
        'Magento_Bundle',
        'Magento_SalesSequence',
        'Magento_CatalogUrlRewrite',
        'Magento_StoreGraphQl',
        'Magento_Widget',
        'Magento_Payment',
        'Magento_Sales',
        'Magento_Checkout',
        'Magento_CmsGraphQl',
        'Magento_Downloadable',
        'Magento_CmsUrlRewrite',
        'Magento_CmsUrlRewriteGraphQl',
        'Magento_User',
        'Magento_ConfigurableProduct',
        'Magento_CatalogSearch',
        'Magento_EavGraphQl',
        'Magento_ConfigurableProductSales',
        'Magento_UrlRewrite',
        'Magento_Contact',
        'Magento_Cookie',
        'Magento_Cron',
        'Magento_CurrencySymbol',
        'Magento_Authorizenet',
        'Magento_Integration',
        'Magento_CustomerGraphQl',
        'Magento_CustomerImportExport',
        'Magento_SampleData',
        'Magento_Deploy',
        'Magento_Developer',
        'Magento_Dhl',
        'Magento_AsynchronousOperations',
        'Magento_DirectoryGraphQl',
        'Magento_GroupedProduct',
        'Magento_CatalogGraphQl',
        'Magento_ImportExport',
        'Magento_Tax',
        'Magento_Weee',
        'Magento_BundleGraphQl',
        'Magento_AdvancedSearch',
        'Magento_Elasticsearch',
        'Magento_Email',
        'Magento_EncryptionKey',
        'Magento_Fedex',
        'Magento_GiftMessage',
        'Magento_GoogleAdwords',
        'Magento_GoogleAnalytics',
        'Magento_Ui',
        'Magento_UrlRewriteGraphQl',
        'Magento_PageCache',
        'Magento_GroupedCatalogInventory',
        'Magento_GroupedImportExport',
        'Magento_CatalogSampleData',
        'Magento_GroupedProductGraphQl',
        'Magento_CatalogRuleConfigurable',
        'Magento_DownloadableImportExport',
        'Magento_GroupedProductSampleData',
        'Magento_InstantPurchase',
        'Magento_Analytics',
        'Magento_Inventory',
        'Magento_InventoryAdminUi',
        'Magento_InventoryApi',
        'Magento_InventoryBundleProduct',
        'Magento_InventoryBundleProductAdminUi',
        'Magento_InventoryCatalog',
        'Magento_InventorySales',
        'Magento_InventoryCatalogAdminUi',
        'Magento_InventoryCatalogApi',
        'Magento_InventoryCatalogSearch',
        'Magento_InventoryConfigurableProduct',
        'Magento_InventoryConfigurableProductAdminUi',
        'Magento_InventoryConfigurableProductIndexer',
        'Magento_InventoryConfiguration',
        'Magento_InventoryConfigurationApi',
        'Magento_InventoryDistanceBasedSourceSelection',
        'Magento_InventoryDistanceBasedSourceSelectionAdminUi',
        'Magento_InventoryDistanceBasedSourceSelectionApi',
        'Magento_InventoryElasticsearch',
        'Magento_InventoryExportStockApi',
        'Magento_InventoryIndexer',
        'Magento_InventorySalesApi',
        'Magento_InventoryGroupedProduct',
        'Magento_InventoryGroupedProductAdminUi',
        'Magento_InventoryGroupedProductIndexer',
        'Magento_InventoryImportExport',
        'Magento_InventoryCache',
        'Magento_InventoryLowQuantityNotification',
        'Magento_InventoryLowQuantityNotificationAdminUi',
        'Magento_InventoryLowQuantityNotificationApi',
        'Magento_InventoryMultiDimensionalIndexerApi',
        'Magento_InventoryProductAlert',
        'Magento_InventoryReservations',
        'Magento_InventoryReservationCli',
        'Magento_InventoryReservationsApi',
        'Magento_InventoryExportStock',
        'Magento_InventorySalesAdminUi',
        'Magento_CatalogInventoryGraphQl',
        'Magento_InventorySalesFrontendUi',
        'Magento_InventorySetupFixtureGenerator',
        'Magento_InventoryShipping',
        'Magento_Shipping',
        'Magento_InventorySourceDeductionApi',
        'Magento_InventorySourceSelection',
        'Magento_InventorySourceSelectionApi',
        'Magento_LayeredNavigation',
        'Magento_Marketplace',
        'Magento_MediaStorage',
        'Magento_MessageQueue',
        'Magento_DownloadableSampleData',
        'Magento_MsrpConfigurableProduct',
        'Magento_MsrpGroupedProduct',
        'Magento_BundleSampleData',
        'Magento_Multishipping',
        'Magento_MysqlMq',
        'Magento_NewRelicReporting',
        'Magento_Newsletter',
        'Magento_OfflinePayments',
        'Magento_SalesRule',
        'Magento_OfflineShipping',
        'Magento_GraphQlCache',
        'Magento_AuthorizenetAcceptjs',
        'Magento_Vault',
        'Magento_Captcha',
        'Magento_Paypal',
        'Magento_Persistent',
        'Magento_ProductAlert',
        'Magento_ConfigurableSampleData',
        'Magento_ProductVideo',
        'Magento_ConfigurableImportExport',
        'Magento_QuoteAnalytics',
        'Magento_QuoteGraphQl',
        'Magento_ReleaseNotification',
        'Magento_Reports',
        'Magento_RequireJs',
        'Magento_Review',
        'Magento_ReviewAnalytics',
        'Magento_ReviewSampleData',
        'Magento_Robots',
        'Magento_Rss',
        'Magento_ThemeSampleData',
        'Magento_Braintree',
        'Magento_SalesAnalytics',
        'Magento_SalesGraphQl',
        'Magento_SalesInventory',
        'Magento_OfflineShippingSampleData',
        'Magento_CatalogRuleSampleData',
        'Magento_TaxSampleData',
        'Magento_CheckoutAgreements',
        'Magento_SalesRuleSampleData',
        'Magento_Elasticsearch6',
        'Magento_CustomerAnalytics',
        'Magento_SendFriend',
        'Magento_SendFriendGraphQl',
        'Magento_InventoryShippingAdminUi',
        'Magento_Signifyd',
        'Magento_Sitemap',
        'Magento_InventoryGraphQl',
        'Magento_ConfigurableProductGraphQl',
        'Magento_Webapi',
        'Magento_SwaggerWebapi',
        'Magento_SwaggerWebapiAsync',
        'Magento_Swatches',
        'Magento_SwatchesGraphQl',
        'Magento_SwatchesLayeredNavigation',
        'Magento_SwatchesSampleData',
        'Magento_MsrpSampleData',
        'Magento_TaxGraphQl',
        'Magento_TaxImportExport',
        'Magento_CustomerSampleData',
        'Magento_DownloadableGraphQl',
        'Magento_ThemeGraphQl',
        'Magento_CmsSampleData',
        'Magento_Tinymce3',
        'Magento_Translation',
        'Magento_GoogleOptimizer',
        'Magento_Ups',
        'Magento_SalesSampleData',
        'Magento_CatalogUrlRewriteGraphQl',
        'Magento_CatalogAnalytics',
        'Magento_Usps',
        'Magento_PaypalCaptcha',
        'MSP_ReCaptcha',
        'Magento_VaultGraphQl',
        'Magento_Version',
        'Magento_Swagger',
        'Magento_WebapiAsync',
        'Magento_WebapiSecurity',
        'Magento_ProductLinksSampleData',
        'Magento_WeeeGraphQl',
        'Magento_CatalogWidget',
        'Magento_WidgetSampleData',
        'Magento_Wishlist',
        'Magento_WishlistAnalytics',
        'Magento_WishlistGraphQl',
        'Magento_WishlistSampleData',
        'Amazon_Core',
        'Amazon_Login',
        'Amazon_Payment',
        'Dotdigitalgroup_Email',
        'Klarna_Core',
        'Klarna_Ordermanagement',
        'Klarna_Kp',
        'Magento_PaypalReCaptcha',
        'MSP_TwoFactorAuth',
        'Temando_Shipping',
        'Vertex_Tax',
    ]);
});
